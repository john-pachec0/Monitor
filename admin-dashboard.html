<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Untwist Feedback Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #FAF8F2;
      color: #332E2B;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h1 {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-label {
      font-size: 14px;
      color: #8C8480;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    select, button {
      padding: 10px 16px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    button {
      background: #D18562;
      color: white;
      border: none;
      font-weight: 500;
    }

    button:hover {
      background: #C07653;
    }

    .feedback-list {
      display: grid;
      gap: 20px;
    }

    .feedback-item {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s;
    }

    .feedback-item:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .feedback-type {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .type-bug_report {
      background: #ffebee;
      color: #c62828;
    }

    .type-feature_request {
      background: #e3f2fd;
      color: #1565c0;
    }

    .type-general_feedback {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    .feedback-date {
      font-size: 13px;
      color: #8C8480;
    }

    .feedback-text {
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 16px;
      white-space: pre-wrap;
    }

    .feedback-diagnostic {
      background: #F5F2ED;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #332E2B;
    }

    .diagnostic-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #8C8480;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .feedback-id {
      font-size: 11px;
      color: #8C8480;
      font-family: monospace;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Untwist Feedback Dashboard</h1>
      <p style="color: #8C8480; margin-top: 8px;">Monitor and manage user feedback</p>
    </header>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Total Feedback</div>
        <div class="stat-value" id="totalCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Bug Reports</div>
        <div class="stat-value" id="bugCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Feature Requests</div>
        <div class="stat-value" id="featureCount">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">General Feedback</div>
        <div class="stat-value" id="generalCount">-</div>
      </div>
    </div>

    <div class="filters">
      <select id="typeFilter">
        <option value="all">All Types</option>
        <option value="bug_report">Bug Reports</option>
        <option value="feature_request">Feature Requests</option>
        <option value="general_feedback">General Feedback</option>
      </select>
      <button onclick="loadFeedback()">Refresh</button>
      <button onclick="exportCSV()">Export CSV</button>
    </div>

    <div id="errorContainer"></div>
    <div id="feedbackContainer" class="feedback-list">
      <div class="loading">Loading feedback...</div>
    </div>
  </div>

  <script>
    // CONFIGURATION
    const API_ENDPOINT = 'https://api.untwist.app/admin/feedback';

    let allFeedback = [];

    // Get API key from prompt on first load
    let apiKey = localStorage.getItem('untwist_admin_api_key');
    if (!apiKey) {
      apiKey = prompt('Enter your API key:');
      if (apiKey) {
        localStorage.setItem('untwist_admin_api_key', apiKey);
      }
    }

    async function loadFeedback() {
      try {
        const response = await fetch(API_ENDPOINT, {
          headers: {
            'x-api-key': apiKey
          }
        });

        if (!response.ok) {
          throw new Error(`Failed to load feedback: ${response.status}`);
        }

        allFeedback = await response.json();
        updateStats();
        renderFeedback();
      } catch (error) {
        showError(error.message);
      }
    }

    function updateStats() {
      document.getElementById('totalCount').textContent = allFeedback.length;
      document.getElementById('bugCount').textContent =
        allFeedback.filter(f => f.type === 'bug_report').length;
      document.getElementById('featureCount').textContent =
        allFeedback.filter(f => f.type === 'feature_request').length;
      document.getElementById('generalCount').textContent =
        allFeedback.filter(f => f.type === 'general_feedback').length;
    }

    function renderFeedback() {
      const typeFilter = document.getElementById('typeFilter').value;
      const filtered = typeFilter === 'all'
        ? allFeedback
        : allFeedback.filter(f => f.type === typeFilter);

      const container = document.getElementById('feedbackContainer');

      if (filtered.length === 0) {
        container.innerHTML = '<div class="loading">No feedback found</div>';
        return;
      }

      container.innerHTML = filtered
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .map(feedback => `
          <div class="feedback-item">
            <div class="feedback-header">
              <span class="feedback-type type-${feedback.type}">
                ${formatType(feedback.type)}
              </span>
              <span class="feedback-date">
                ${formatDate(feedback.timestamp)}
              </span>
            </div>
            <div class="feedback-text">${escapeHtml(feedback.feedback)}</div>
            ${feedback.diagnostic ? `
              <div class="feedback-diagnostic">
                <div class="diagnostic-row">
                  <strong>App Version:</strong>
                  <span>${feedback.diagnostic.appVersion || 'N/A'}</span>
                </div>
                <div class="diagnostic-row">
                  <strong>iOS Version:</strong>
                  <span>${feedback.diagnostic.iosVersion || 'N/A'}</span>
                </div>
                <div class="diagnostic-row">
                  <strong>Device:</strong>
                  <span>${feedback.diagnostic.device || 'N/A'}</span>
                </div>
                <div class="diagnostic-row">
                  <strong>Locale:</strong>
                  <span>${feedback.diagnostic.locale || 'N/A'}</span>
                </div>
              </div>
            ` : ''}
            <div class="feedback-id">ID: ${feedback.feedbackId}</div>
          </div>
        `).join('');
    }

    function formatType(type) {
      const typeMap = {
        'bug_report': 'Bug Report',
        'feature_request': 'Feature Request',
        'general_feedback': 'General Feedback'
      };
      return typeMap[type] || type;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message) {
      const container = document.getElementById('errorContainer');
      container.innerHTML = `<div class="error">Error: ${escapeHtml(message)}</div>`;
    }

    function exportCSV() {
      const typeFilter = document.getElementById('typeFilter').value;
      const filtered = typeFilter === 'all'
        ? allFeedback
        : allFeedback.filter(f => f.type === typeFilter);

      const headers = ['Timestamp', 'Type', 'Feedback', 'App Version', 'iOS Version', 'Device', 'Locale', 'ID'];
      const rows = filtered.map(f => [
        f.timestamp,
        f.type,
        f.feedback.replace(/"/g, '""'), // Escape quotes
        f.diagnostic?.appVersion || '',
        f.diagnostic?.iosVersion || '',
        f.diagnostic?.device || '',
        f.diagnostic?.locale || '',
        f.feedbackId
      ]);

      const csv = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `untwist-feedback-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }

    // Event listeners
    document.getElementById('typeFilter').addEventListener('change', renderFeedback);

    // Load on page load
    loadFeedback();
  </script>
</body>
</html>
